version: '3'

tasks:
  php:tools:
    desc: "T√©l√©charge les outils PHP dans un dossier sp√©cifique"
    silent: true
    summary: |
      T√©l√©charge une collection d'outils PHP populaires dans un dossier.

      Variables:
      - TOOLS_DIR: Dossier de destination (d√©faut: ./tools/php)
      - FORCE: Force le t√©l√©chargement m√™me si le fichier existe (d√©faut: false)

      Outils t√©l√©charg√©s:
      - phploc.phar (PHP Lines of Code)
      - php-cs-fixer.phar (PHP CS Fixer)
      - phpmd.phar (PHP Mess Detector)
      - phpcbf.phar (PHP Code Beautifier)
      - phpcs.phar (PHP Code Sniffer)
      - phpstan.phar (PHPStan)
      - phpDocumentor.phar (phpDocumentor)
      - behat.phar (Behat)

      Exemples:
      task download:php:tools
      task download:php:tools TOOLS_DIR=./bin
      task download:php:tools FORCE=true
    vars:
      TOOLS_DIR: '{{.TOOLS_DIR | default "./tools/php"}}'
      FORCE: '{{.FORCE | default "false"}}'
    cmds:
    - |
      echo "üì¶ T√©l√©chargement des outils PHP dans '{{.TOOLS_DIR}}'..."
      echo ""

      # Cr√©ation du dossier de destination
      mkdir -p "{{.TOOLS_DIR}}"

      # D√©finition des outils √† t√©l√©charger (format: nom|url)
      tools=(
        "phploc.phar|https://phar.phpunit.de/phploc-7.0.2.phar"
        "php-cs-fixer.phar|https://github.com/FriendsOfPHP/PHP-CS-Fixer/releases/download/v3.64.0/php-cs-fixer.phar"
        "phpmd.phar|https://github.com/phpmd/phpmd/releases/download/2.15.0/phpmd.phar"
        "phpcbf.phar|https://github.com/squizlabs/PHP_CodeSniffer/releases/download/3.7.2/phpcbf.phar"
        "phpcs.phar|https://github.com/squizlabs/PHP_CodeSniffer/releases/download/3.7.2/phpcs.phar"
        "phpstan.phar|https://github.com/phpstan/phpstan/releases/download/1.12.4/phpstan.phar"
        "phpDocumentor.phar|https://github.com/phpDocumentor/phpDocumentor/releases/download/v3.5.3/phpDocumentor.phar"
        "behat.phar|https://github.com/Behat/Behat/releases/download/v3.14.0/behat.phar"
      )

      # Compteurs
      downloaded=0
      skipped=0
      errors=0

      # T√©l√©chargement de chaque outil
      for tool_info in "${tools[@]}"; do
        tool=$(echo "$tool_info" | cut -d'|' -f1)
        url=$(echo "$tool_info" | cut -d'|' -f2)
        target_file="{{.TOOLS_DIR}}/$tool"
        
        echo -n "‚¨áÔ∏è  $tool ... "
        
        # V√©rifier si le fichier existe d√©j√†
        if [ -f "$target_file" ] && [ "{{.FORCE}}" != "true" ]; then
          echo "‚è≠Ô∏è  d√©j√† pr√©sent"
          skipped=$((skipped + 1))
          continue
        fi
        
        # T√©l√©charger le fichier
        if curl -L -s -o "$target_file" "$url"; then
          # V√©rifier que le t√©l√©chargement a r√©ussi
          if [ -f "$target_file" ] && [ -s "$target_file" ]; then
            # Rendre le fichier ex√©cutable
            chmod +x "$target_file"
            echo "‚úÖ t√©l√©charg√©"
            downloaded=$((downloaded + 1))
          else
            echo "‚ùå √©chec (fichier vide)"
            rm -f "$target_file"
            errors=$((errors + 1))
          fi
        else
          echo "‚ùå √©chec du t√©l√©chargement"
          rm -f "$target_file"
          errors=$((errors + 1))
        fi
      done

      echo ""
      echo "üìä R√©sum√© :"
      echo "  ‚úÖ T√©l√©charg√©s: $downloaded"
      echo "  ‚è≠Ô∏è  Ignor√©s: $skipped"
      echo "  ‚ùå Erreurs: $errors"
      echo ""

      if [ $downloaded -gt 0 ]; then
        echo "üìÅ Outils disponibles dans '{{.TOOLS_DIR}}' :"
        ls -la "{{.TOOLS_DIR}}"/*.phar 2>/dev/null | awk '{print "  " $9 " (" $5 " bytes)"}'
      fi

      if [ $errors -gt 0 ]; then
        echo ""
        echo "‚ö†Ô∏è  Certains t√©l√©chargements ont √©chou√©. V√©rifiez votre connexion internet."
      fi

  php:tools:update:
    desc: "Met √† jour tous les outils PHP (force le t√©l√©chargement)"
    silent: true
    summary: |
      Force la mise √† jour de tous les outils PHP m√™me s'ils existent d√©j√†.

      Variables:
      - TOOLS_DIR: Dossier de destination (d√©faut: ./tools/php)

      Exemple:
      task download:php:tools:update
    vars:
      TOOLS_DIR: '{{.TOOLS_DIR | default "./tools/php"}}'
    cmds:
    - task: php:tools
      vars:
        TOOLS_DIR: '{{.TOOLS_DIR}}'
        FORCE: "true"

  php:tools:list:
    desc: "Liste les outils PHP t√©l√©charg√©s"
    silent: true
    summary: |
      Affiche la liste des outils PHP pr√©sents dans le dossier.

      Variables:
      - TOOLS_DIR: Dossier √† v√©rifier (d√©faut: ./tools/php)
    vars:
      TOOLS_DIR: '{{.TOOLS_DIR | default "./tools/php"}}'
    cmds:
    - |
      if [ ! -d "{{.TOOLS_DIR}}" ]; then
        echo "‚ùå Le dossier '{{.TOOLS_DIR}}' n'existe pas"
        echo "üí° Utilisez 'task download:php:tools' pour t√©l√©charger les outils"
        exit 1
      fi

      echo "üìÅ Outils PHP dans '{{.TOOLS_DIR}}' :"
      echo ""

      tools_found=0
      for tool in phploc.phar php-cs-fixer.phar phpmd.phar phpcbf.phar phpcs.phar phpstan.phar phpDocumentor.phar behat.phar; do
        if [ -f "{{.TOOLS_DIR}}/$tool" ]; then
          size=$(ls -lh "{{.TOOLS_DIR}}/$tool" | awk '{print $5}')
          perms=$(ls -l "{{.TOOLS_DIR}}/$tool" | awk '{print $1}')
          echo "  ‚úÖ $tool ($size) $perms"
          tools_found=$((tools_found + 1))
        else
          echo "  ‚ùå $tool (manquant)"
        fi
      done

      echo ""
      echo "üìä $tools_found/8 outils pr√©sents"

      if [ $tools_found -lt 8 ]; then
        echo ""
        echo "üí° Pour t√©l√©charger les outils manquants :"
        echo "   task download:php:tools"
      fi

  php:tools:clean:
    desc: "Supprime tous les outils PHP t√©l√©charg√©s"
    silent: true
    summary: |
      Supprime le dossier contenant les outils PHP.

      Variables:
      - TOOLS_DIR: Dossier √† supprimer (d√©faut: ./tools/php)

      ‚ö†Ô∏è  ATTENTION: Cette action est irr√©versible !
    vars:
      TOOLS_DIR: '{{.TOOLS_DIR | default "./tools/php"}}'
    cmds:
    - |
      if [ ! -d "{{.TOOLS_DIR}}" ]; then
        echo "‚ùå Le dossier '{{.TOOLS_DIR}}' n'existe pas"
        exit 1
      fi

      echo "üóëÔ∏è  Suppression du dossier '{{.TOOLS_DIR}}' et de tous les outils..."
      read -p "√ätes-vous s√ªr ? [y/N] " -n 1 -r
      echo
      if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "{{.TOOLS_DIR}}"
        echo "‚úÖ Dossier supprim√©"
      else
        echo "‚ùå Suppression annul√©e"
      fi
