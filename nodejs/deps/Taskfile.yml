version: '3'

# Taskfile pour la gestion des devDependencies Node.js

tasks:
  add:
    desc: "Ajoute les devDependencies communes si elles ne sont pas dÃ©jÃ  prÃ©sentes"
    silent: true
    summary: |
      Ajoute intelligemment les devDependencies communes sans version spÃ©cifique.
      VÃ©rifie l'existence avant installation pour Ã©viter les doublons.

      Variables:
      - DEV_DEPS: Liste des dÃ©pendances (dÃ©finie globalement)

      Exemple:
      task nodejs:deps:add
    preconditions:
    - sh: command -v npm
      msg: "npm n'est pas installÃ© ou accessible"
    - sh: "test -f package.json"
      msg: "Le fichier package.json est requis pour cette tÃ¢che"
    cmds:
    - |
      # Convertit la variable DEV_DEPS en tableau
      tool_names=({{.DEV_DEPS}})

      # VÃ©rifie si package.json existe et contient devDependencies
      if [ ! -f package.json ]; then
        echo "âŒ Erreur: package.json introuvable"
        exit 1
      fi

      # CrÃ©e la section devDependencies si elle n'existe pas
      if ! grep -q '"devDependencies"' package.json; then
        # Ajoute une section devDependencies vide
        npm pkg set devDependencies='{}'
      fi

      # Pour chaque dÃ©pendance, vÃ©rifie si elle existe dÃ©jÃ 
      added=0
      skipped=0
      for package_name in "${tool_names[@]}"; do
        # VÃ©rifie si le package est dÃ©jÃ  dans devDependencies
        if ! npm pkg get devDependencies | grep -q "\"$package_name\""; then
          echo "ğŸ“¦ Installation de $package_name..."
          npm install --save-dev "$package_name"
          added=$((added + 1))
        else
          echo "â­ï¸  $package_name est dÃ©jÃ  installÃ©, ignorÃ©."
          skipped=$((skipped + 1))
        fi
      done

      echo ""
      echo "ğŸ“Š RÃ©sumÃ© :"
      echo "  âœ… AjoutÃ©es: $added"
      echo "  â­ï¸  IgnorÃ©es: $skipped"
      echo "âœ… VÃ©rification des devDependencies terminÃ©e."

  add-force:
    desc: "Ajoute/met Ã  jour toutes les devDependencies communes (force l'installation)"
    silent: true
    summary: |
      Force l'installation/mise Ã  jour de toutes les devDependencies communes.
      Installe les derniÃ¨res versions sans vÃ©rification prÃ©alable.

      Variables:
      - DEV_DEPS: Liste des dÃ©pendances (dÃ©finie globalement)

      Exemple:
      task nodejs:deps:add-force
    preconditions:
    - sh: command -v npm
      msg: "npm n'est pas installÃ© ou accessible"
    - sh: "test -f package.json"
      msg: "Le fichier package.json est requis pour cette tÃ¢che"
    cmds:
    - |
      # Convertit la variable DEV_DEPS en tableau
      tool_names=({{.DEV_DEPS}})

      echo "ğŸ“¦ Installation/mise Ã  jour de toutes les devDependencies..."
      installed=0
      for package_name in "${tool_names[@]}"; do
        echo "ğŸ“¦ Installation de $package_name..."
        npm install --save-dev "$package_name"
        installed=$((installed + 1))
      done

      echo ""
      echo "ğŸ“Š RÃ©sumÃ© :"
      echo "  âœ… InstallÃ©es/mises Ã  jour: $installed"
      echo "âœ… Installation/mise Ã  jour des devDependencies terminÃ©e."

  list:
    desc: "Liste les devDependencies communes disponibles"
    silent: true
    summary: |
      Affiche la liste des devDependencies communes et leur statut d'installation.

      Variables:
      - DEV_DEPS: Liste des dÃ©pendances (dÃ©finie globalement)
    cmds:
    - |
      echo "ğŸ“‹ DevDependencies communes disponibles :"
      echo ""

      # Convertit la variable DEV_DEPS en tableau, en supprimant les espaces vides
      all_deps="{{.DEV_DEPS}}"
      tool_names=()
      for dep in $all_deps; do
        if [ -n "$dep" ]; then
          tool_names+=("$dep")
        fi
      done

      total=${#tool_names[@]}
      installed=0

      for package_name in "${tool_names[@]}"; do
        if [ -f package.json ] && npm pkg get devDependencies | grep -q "\"$package_name\""; then
          # RÃ©cupÃ¨re la version installÃ©e
          version=$(npm pkg get devDependencies | jq -r ".[\"$package_name\"]" 2>/dev/null || echo "version inconnue")
          echo "  âœ… $package_name ($version)"
          installed=$((installed + 1))
        else
          echo "  âŒ $package_name (non installÃ©)"
        fi
      done

      echo ""
      echo "ğŸ“Š $installed/$total dÃ©pendances installÃ©es"

      if [ $installed -lt $total ]; then
        echo ""
        echo "ğŸ’¡ Pour installer les dÃ©pendances manquantes :"
        echo "   task nodejs:deps:add"
      fi

  check:
    desc: "VÃ©rifie les devDependencies pour les mises Ã  jour"
    silent: true
    summary: |
      VÃ©rifie les devDependencies communes pour les mises Ã  jour disponibles.

      Exemple:
      task nodejs:deps:check
    preconditions:
    - sh: command -v npm
      msg: "npm n'est pas installÃ© ou accessible"
    - sh: "test -f package.json"
      msg: "Le fichier package.json est requis pour cette tÃ¢che"
    cmds:
    - |
      echo "ğŸ” VÃ©rification des mises Ã  jour disponibles..."
      echo ""

      # Convertit la variable DEV_DEPS en tableau
      tool_names=({{.DEV_DEPS}})

      outdated=0
      for package_name in "${tool_names[@]}"; do
        if npm pkg get devDependencies | grep -q "\"$package_name\""; then
          # VÃ©rifie si une mise Ã  jour est disponible
          if npm outdated "$package_name" 2>/dev/null | grep -q "$package_name"; then
            current=$(npm list "$package_name" --depth=0 2>/dev/null | grep "$package_name" | awk '{print $2}' | sed 's/@//')
            latest=$(npm view "$package_name" version 2>/dev/null)
            echo "  ğŸ“ˆ $package_name: $current â†’ $latest"
            outdated=$((outdated + 1))
          else
            echo "  âœ… $package_name: Ã  jour"
          fi
        else
          echo "  âš ï¸  $package_name: non installÃ©"
        fi
      done

      echo ""
      if [ $outdated -gt 0 ]; then
        echo "ğŸ“Š $outdated dÃ©pendance(s) peuvent Ãªtre mises Ã  jour"
        echo ""
        echo "ğŸ’¡ Pour mettre Ã  jour :"
        echo "   task nodejs:deps:add-force"
      else
        echo "âœ… Toutes les dÃ©pendances sont Ã  jour"
      fi

  remove:
    desc: "Supprime les devDependencies communes"
    silent: true
    summary: |
      Supprime toutes les devDependencies communes du projet.

      Variables:
      - DEV_DEPS: Liste des dÃ©pendances (dÃ©finie globalement)
      - CONFIRM: Confirmer la suppression (dÃ©faut: demande confirmation)

      Exemple:
      task nodejs:deps:remove
      task nodejs:deps:remove CONFIRM=true
    vars:
      CONFIRM: '{{.CONFIRM | default "false"}}'
    preconditions:
    - sh: command -v npm
      msg: "npm n'est pas installÃ© ou accessible"
    - sh: "test -f package.json"
      msg: "Le fichier package.json est requis pour cette tÃ¢che"
    cmds:
    - |
      echo "ğŸ—‘ï¸  Suppression des devDependencies communes..."
      echo ""

      # Convertit la variable DEV_DEPS en tableau
      tool_names=({{.DEV_DEPS}})

      # Liste les dÃ©pendances Ã  supprimer
      to_remove=()
      for package_name in "${tool_names[@]}"; do
        if npm pkg get devDependencies | grep -q "\"$package_name\""; then
          to_remove+=("$package_name")
          echo "  ğŸ—‘ï¸  $package_name sera supprimÃ©"
        fi
      done

      if [ ${#to_remove[@]} -eq 0 ]; then
        echo "âœ… Aucune devDependency commune Ã  supprimer"
        exit 0
      fi

      echo ""
      echo "ğŸ“Š ${#to_remove[@]} dÃ©pendance(s) seront supprimÃ©es"

      # Demande de confirmation
      if [ "{{.CONFIRM}}" != "true" ]; then
        echo ""
        read -p "Confirmer la suppression ? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
          echo "âŒ Suppression annulÃ©e"
          exit 0
        fi
      fi

      # Suppression
      removed=0
      for package_name in "${to_remove[@]}"; do
        echo "ğŸ—‘ï¸  Suppression de $package_name..."
        npm uninstall "$package_name"
        removed=$((removed + 1))
      done

      echo ""
      echo "ğŸ“Š RÃ©sumÃ© :"
      echo "  ğŸ—‘ï¸  SupprimÃ©es: $removed"
      echo "âœ… Suppression des devDependencies terminÃ©e."
