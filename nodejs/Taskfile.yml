version: 3
# Taskfile pour les projets Node.js

vars:
  DEV_DEPS: "all-contributors-cli cypress generate-changelog gitmoji-changelog jscpd license-checker markdownlint-cli npm-run-all readme-md-generator semantic-git-commit-cli yaml"

tasks:
  install:
    desc: "Installe les dÃ©pendances Node.js"
    silent: true
    preconditions:
    - sh: command -v npm
    - sh: "test -f package.json"
      msg: "Le fichier package.json est requis pour cette tÃ¢che"
    cmds:
    - npm install
  init:
    desc: "Initialise le projet Node.js en installant les dÃ©pendances"
    silent: true
    preconditions:
    - sh: command -v npm
    cmds:
    - npm init -y

  add-dev-deps:
    desc: "Ajoute les devDependencies communes si elles ne sont pas dÃ©jÃ  prÃ©sentes"
    silent: true
    preconditions:
    - sh: command -v npm
      msg: "npm n'est pas installÃ© ou accessible"
    - sh: "test -f package.json"
      msg: "Le fichier package.json est requis pour cette tÃ¢che"
    cmds:
    - |
      echo "ğŸ“¦ Installation des devDependencies communes..."
      echo ""

      # Liste directe des packages
      packages="all-contributors-cli cypress generate-changelog gitmoji-changelog jscpd license-checker markdownlint-cli npm-run-all readme-md-generator semantic-git-commit-cli yaml"

      # CrÃ©e la section devDependencies si elle n'existe pas
      if ! grep -q '"devDependencies"' package.json; then
        echo "ğŸ“ CrÃ©ation de la section devDependencies..."
        npm pkg set devDependencies='{}'
      fi

      # Installation des packages
      added=0
      skipped=0

      for package_name in $packages; do
        # VÃ©rifie si le package est dÃ©jÃ  dans devDependencies
        if ! npm pkg get devDependencies | grep -q "\"$package_name\""; then
          echo "ğŸ“¦ Installation de $package_name..."
          if npm install --save-dev "$package_name"; then
            added=$((added + 1))
          else
            echo "âŒ Erreur lors de l'installation de $package_name"
          fi
        else
          echo "â­ï¸  $package_name est dÃ©jÃ  installÃ©, ignorÃ©."
          skipped=$((skipped + 1))
        fi
      done

      echo ""
      echo "ğŸ“Š RÃ©sumÃ© :"
      echo "  âœ… AjoutÃ©es: $added"
      echo "  â­ï¸  IgnorÃ©es: $skipped"
      echo "âœ… Installation des devDependencies terminÃ©e."
