version: '3'

# Taskfile pour l'analyse et l'historique Docker

tasks:
  container:lifecycle:
    desc: "Analyse le cycle de vie d'un conteneur"
    silent: true
    preconditions:
    - sh: command -v docker
      msg: "Docker n'est pas installÃ© ou accessible"
    summary: |
      Analyse complÃ¨te du cycle de vie d'un conteneur avec tous les Ã©vÃ©nements.

      Variables:
      - CONTAINER_NAME: Nom du conteneur (requis)

      Exemple:
      task docker:analyze:container:lifecycle CONTAINER_NAME=mon-conteneur
    cmds:
    - |
      if [ -z "{{.CONTAINER_NAME}}" ]; then
        echo "âŒ CONTAINER_NAME est requis"
        echo "ğŸ“‹ Conteneurs disponibles :"
        docker ps -a --format "table {{{{.Names}}}}\t{{{{.Image}}}}\t{{{{.Status}}}}"
        exit 1
      fi

      echo "ğŸ”¬ Analyse du cycle de vie du conteneur '{{.CONTAINER_NAME}}' :"
      echo ""

      # Informations de base
      task: info:container:inspect CONTAINER_NAME={{.CONTAINER_NAME}}

      echo ""
      echo "ğŸ“Š Historique des Ã©vÃ©nements (si disponible) :"
      echo "   Note: Les Ã©vÃ©nements Docker sont conservÃ©s temporairement"

      # Tentative de rÃ©cupÃ©ration des Ã©vÃ©nements rÃ©cents
      container_id=$(docker inspect {{.CONTAINER_NAME}} --format "{{{{.Id}}}}" 2>/dev/null || echo "")
      if [ -n "$container_id" ]; then
        docker events --since 24h --filter container=$container_id --format "{{{{.Time}}}} - {{{{.Action}}}}" 2>/dev/null || echo "   Aucun Ã©vÃ©nement rÃ©cent trouvÃ©"
      fi

  container:performance:
    desc: "Analyse les performances d'un conteneur"
    silent: true
    preconditions:
    - sh: command -v docker
      msg: "Docker n'est pas installÃ© ou accessible"
    summary: |
      Analyse les performances et l'utilisation des ressources d'un conteneur.

      Variables:
      - CONTAINER_NAME: Nom du conteneur (requis)
      - DURATION: DurÃ©e d'observation en secondes (dÃ©faut: 10)

      Exemple:
      task docker:analyze:container:performance CONTAINER_NAME=mon-conteneur
    vars:
      DURATION: '{{.DURATION | default "10"}}'
    cmds:
    - |
      if [ -z "{{.CONTAINER_NAME}}" ]; then
        echo "âŒ CONTAINER_NAME est requis"
        echo "ğŸ“‹ Conteneurs disponibles :"
        docker ps --format "table {{{{.Names}}}}\t{{{{.Image}}}}\t{{{{.Status}}}}"
        exit 1
      fi

      echo "ğŸ“Š Analyse des performances du conteneur '{{.CONTAINER_NAME}}' :"
      echo "â±ï¸  Observation pendant {{.DURATION}} secondes..."
      echo ""

      # Statistiques instantanÃ©es
      echo "ğŸ“ˆ Statistiques instantanÃ©es :"
      docker stats --no-stream {{.CONTAINER_NAME}}

      echo ""
      echo "ğŸ”„ Observation en temps rÃ©el ({{.DURATION}}s) :"
      timeout {{.DURATION}} docker stats {{.CONTAINER_NAME}} || echo "âœ… Observation terminÃ©e"

  history:containers:
    desc: "Affiche l'historique des conteneurs (y compris arrÃªtÃ©s)"
    silent: true
    preconditions:
    - sh: command -v docker
      msg: "Docker n'est pas installÃ© ou accessible"
    summary: |
      Affiche tous les conteneurs (actifs et arrÃªtÃ©s) avec leurs informations de dÃ©marrage.

      Variables:
      - IMAGE_NAME: Filtrer par image (optionnel)
      - STATUS: Filtrer par statut (running, exited, etc.)
    vars:
      STATUS: '{{.STATUS | default ""}}'
    cmds:
    - |
      echo "ğŸ“œ Historique de tous les conteneurs :"
      echo ""

      filter_opts=""
      if [ -n "{{.IMAGE_NAME}}" ]; then
        echo "ğŸ¯ Filtrage pour l'image: {{.IMAGE_NAME}}"
        filter_opts="--filter ancestor={{.IMAGE_NAME}}"
      fi

      if [ -n "{{.STATUS}}" ]; then
        echo "ğŸ¯ Filtrage pour le statut: {{.STATUS}}"
        filter_opts="$filter_opts --filter status={{.STATUS}}"
      fi

      docker ps -a $filter_opts --format "table {{{{.Names}}}}\t{{{{.Image}}}}\t{{{{.Status}}}}\t{{{{.CreatedAt}}}}"

  system:overview:
    desc: "Analyse globale du systÃ¨me Docker"
    silent: true
    preconditions:
    - sh: command -v docker
      msg: "Docker n'est pas installÃ© ou accessible"
    summary: |
      Analyse complÃ¨te du systÃ¨me Docker : images, conteneurs, volumes, rÃ©seaux.

      Exemple:
      task docker:analyze:system:overview
    cmds:
    - |
      echo "ğŸ³ Analyse globale du systÃ¨me Docker :"
      echo ""

      echo "ğŸ“Š Informations systÃ¨me :"
      docker system df

      echo ""
      echo "ğŸƒâ€â™‚ï¸ Conteneurs actifs :"
      docker ps --format "table {{{{.Names}}}}\t{{{{.Image}}}}\t{{{{.Status}}}}\t{{{{.Ports}}}}"

      echo ""
      echo "ğŸ’¾ Images locales :"
      docker images --format "table {{{{.Repository}}}}\t{{{{.Tag}}}}\t{{{{.Size}}}}\t{{{{.CreatedAt}}}}"

      echo ""
      echo "ğŸ”— RÃ©seaux :"
      docker network ls

      echo ""
      echo "ğŸ“ Volumes :"
      docker volume ls

      echo ""
      echo "âš ï¸  Ressources inutilisÃ©es :"
      docker system df | grep -E "(TYPE|<none>|Total reclaimed)"

  image:layers:
    desc: "Analyse les couches d'une image Docker"
    silent: true
    preconditions:
    - sh: command -v docker
      msg: "Docker n'est pas installÃ© ou accessible"
    summary: |
      Analyse la structure en couches d'une image Docker.

      Variables:
      - IMAGE_NAME: Nom de l'image (requis)

      Exemple:
      task docker:analyze:image:layers IMAGE_NAME=nginx:latest
    cmds:
    - |
      if [ -z "{{.IMAGE_NAME}}" ]; then
        echo "âŒ IMAGE_NAME est requis"
        echo "ğŸ“‹ Images disponibles :"
        docker images --format "table {{{{.Repository}}}}\t{{{{.Tag}}}}\t{{{{.Size}}}}"
        exit 1
      fi

      echo "ğŸ”¬ Analyse des couches de l'image '{{.IMAGE_NAME}}' :"
      echo ""

      echo "ğŸ“‹ Informations de base :"
      docker inspect {{.IMAGE_NAME}} --format "{{{{json .}}}" | jq -r '
        "ID: " + .Id,
        "Taille: " + (.Size | tostring) + " bytes",
        "Architecture: " + .Architecture,
        "OS: " + .Os,
        "CrÃ©Ã©: " + .Created
      ' 2>/dev/null || docker inspect {{.IMAGE_NAME}}

      echo ""
      echo "ğŸ“š Historique des couches :"
      docker history {{.IMAGE_NAME}}
