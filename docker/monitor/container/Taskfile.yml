version: '3'

# Taskfile pour le monitoring des conteneurs Docker

vars:
  CONTAINER_NAME: '{{.CONTAINER_NAME | default ""}}'
  CONTAINERS: '{{.CONTAINERS | default ""}}'
  IMAGE_NAME: '{{.IMAGE_NAME | default ""}}'
  STACK_NAME: '{{.STACK_NAME | default "taskfiles-stack"}}'
  TIMEOUT: '{{.TIMEOUT | default "300"}}'
  CHECK_INTERVAL: '{{.CHECK_INTERVAL | default "10"}}'

tasks:
  start:
    desc: "Surveille le lancement de conteneurs en temps rÃ©el"
    silent: true
    preconditions:
    - sh: command -v docker
      msg: "Docker n'est pas installÃ© ou accessible"
    summary: |
      Surveille les Ã©vÃ©nements Docker pour dÃ©tecter le lancement de conteneurs.
      Affiche quand une image est lancÃ©e avec l'horodatage.

      Variables:
      - IMAGE_NAME: Filtrer par nom d'image spÃ©cifique (optionnel)

      Exemples:
      task docker:monitor:container:start
      task docker:monitor:container:start IMAGE_NAME=nginx
    cmds:
    - |
      echo "ğŸ” Surveillance des lancements de conteneurs en temps rÃ©el..."
      echo "   Appuyez sur Ctrl+C pour arrÃªter"
      echo ""

      if [ -n "{{.IMAGE_NAME}}" ]; then
        echo "ğŸ¯ Filtrage pour l'image: {{.IMAGE_NAME}}"
        docker events --filter container --filter event=start --filter image={{.IMAGE_NAME}} --format "{.TimeNano} - ğŸš€ Container {.Actor.Attributes.name} ({.Actor.Attributes.image}) started"
      else
        docker events --filter container --filter event=start --format "{.TimeNano} - ğŸš€ Container {.Actor.Attributes.name} ({.Actor.Attributes.image}) started"
      fi

  status:
    desc: "VÃ©rifie le statut d'un conteneur spÃ©cifique"
    silent: true
    preconditions:
    - sh: command -v docker
      msg: "Docker n'est pas installÃ© ou accessible"
    summary: |
      Affiche le statut dÃ©taillÃ© d'un conteneur.

      Variables:
      - CONTAINER_NAME: Nom du conteneur (requis)

      Exemple:
      task docker:monitor:container:status CONTAINER_NAME=mon-conteneur
    cmds:
    - |
      if [ -z "{{.CONTAINER_NAME}}" ]; then
        echo "âŒ CONTAINER_NAME est requis"
        echo "ğŸ“‹ Conteneurs disponibles :"
        docker ps -a --format "table {.Names}\t{.Image}\t{.Status}"
        exit 1
      fi

      echo "ğŸ” Statut du conteneur '{{.CONTAINER_NAME}}' :"
      echo ""

      # VÃ©rifier si le conteneur existe
      if ! docker ps -a --filter "name={{.CONTAINER_NAME}}" --format "{.Names}" | grep -q "^{{.CONTAINER_NAME}}$"; then
        echo "âŒ Le conteneur '{{.CONTAINER_NAME}}' n'existe pas"
        exit 1
      fi

      # Informations de base
      echo "ğŸ“Š Informations gÃ©nÃ©rales :"
      docker ps -a --filter "name={{.CONTAINER_NAME}}" --format "table {.Names}\t{.Image}\t{.Status}\t{.Ports}"

      echo ""
      echo "ğŸ¥ Ã‰tat de santÃ© :"
      health_status=$(docker inspect {{.CONTAINER_NAME}} --format='{.State.Health.Status}' 2>/dev/null || echo "no-healthcheck")

      case $health_status in
        "healthy")
          echo "  âœ… Sain"
          ;;
        "unhealthy")
          echo "  âŒ Non sain"
          echo "  ğŸ“‹ Derniers checks :"
          docker inspect {{.CONTAINER_NAME}} --format='{range .State.Health.Log}{.Start} - {.ExitCode} - {.Output}{end}' | tail -5
          ;;
        "starting")
          echo "  ğŸŸ¡ DÃ©marrage en cours"
          ;;
        "no-healthcheck")
          echo "  â„¹ï¸  Pas de healthcheck configurÃ©"
          ;;
        *)
          echo "  â“ Ã‰tat inconnu ($health_status)"
          ;;
      esac

      echo ""
      echo "ğŸ’¾ Utilisation des ressources :"
      docker stats {{.CONTAINER_NAME}} --no-stream --format "table {.Container}\t{.CPUPerc}\t{.MemUsage}\t{.NetIO}\t{.BlockIO}"

  batch:status:
    desc: "VÃ©rifie le statut de plusieurs conteneurs"
    silent: true
    preconditions:
    - sh: command -v docker
      msg: "Docker n'est pas installÃ© ou accessible"
    summary: |
      VÃ©rifie le statut de plusieurs conteneurs d'une liste.

      Variables:
      - CONTAINERS: Liste des conteneurs sÃ©parÃ©s par des virgules (requis)
      - STACK_NAME: Nom de la stack pour prÃ©fixer les noms (optionnel)

      Exemple:
      task docker:monitor:container:batch:status CONTAINERS="traefik,portainer,app" STACK_NAME=production
    cmds:
    - |
      if [ -z "{{.CONTAINERS}}" ]; then
        echo "âŒ CONTAINERS est requis (ex: 'traefik,portainer,app')"
        exit 1
      fi

      echo "ğŸ“Š Statut des conteneurs : {{.CONTAINERS}}"
      echo ""

      # Convertir la liste en tableau
      IFS=',' read -ra CONTAINER_ARRAY <<< "{{.CONTAINERS}}"

      for container in "${CONTAINER_ARRAY[@]}"; do
        container=$(echo "$container" | xargs)  # Trim whitespace
        
        if [ -n "{{.STACK_NAME}}" ]; then
          full_name="{{.STACK_NAME}}_${container}"
        else
          full_name="$container"
        fi
        
        echo "ğŸ” $container :"
        
        # VÃ©rifier si le conteneur existe et est en cours d'exÃ©cution
        if docker ps --filter "name=$full_name" --format "{.Names}" | grep -q "$full_name"; then
          status=$(docker ps --filter "name=$full_name" --format "{.Status}")
          echo "  âœ… Actif - $status"
          
          # VÃ©rifier l'Ã©tat de santÃ© si disponible
          health_status=$(docker inspect "$full_name" --format='{.State.Health.Status}' 2>/dev/null || echo "no-healthcheck")
          if [ "$health_status" != "no-healthcheck" ]; then
            case $health_status in
              "healthy") echo "  ğŸ¥ Sain" ;;
              "unhealthy") echo "  ğŸš¨ Non sain" ;;
              "starting") echo "  ğŸŸ¡ VÃ©rification de santÃ© en cours" ;;
            esac
          fi
        else
          echo "  âŒ Non actif ou inexistant"
        fi
        echo ""
      done
