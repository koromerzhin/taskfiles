version: '3'

tasks:
  list:
    desc: "Liste toutes les images utilisÃ©es dans docker-compose.yml"
    silent: true
    preconditions:
    - sh: command -v docker
      msg: "Docker n'est pas installÃ© ou accessible"
    summary: |
      Extrait et affiche toutes les images dÃ©finies dans un fichier docker-compose.yml.

      Variables:
      - COMPOSE_FILE: Chemin vers le fichier docker-compose (dÃ©faut: docker-compose.yml)

      Exemples:
      task docker:images:list
      task docker:images:list COMPOSE_FILE=docker-compose.prod.yml
    vars:
      COMPOSE_FILE: '{{.COMPOSE_FILE | default "docker-compose.yml"}}'
    cmds:
    - |
      if [ ! -f "{{.COMPOSE_FILE}}" ]; then
        echo "âŒ Le fichier '{{.COMPOSE_FILE}}' n'existe pas"
        echo "ğŸ“ Fichiers docker-compose disponibles :"
        find . -name "docker-compose*.yml" -o -name "compose*.yml" 2>/dev/null || echo "   Aucun fichier docker-compose trouvÃ©"
        exit 1
      fi

      echo "ğŸ“‹ Images extraites de '{{.COMPOSE_FILE}}' :"
      echo ""

      # Extraction des images avec yq si disponible, sinon avec grep/sed
      grep -E "^\s*image:" {{.COMPOSE_FILE}} | sed 's/.*image:\s*//' | sed 's/["'\'']*//g' | sort | uniq | while read -r image; do
        if [ -n "$image" ]; then
          echo "  ğŸ³ $image"
        fi
      done

  pull:
    desc: "TÃ©lÃ©charge toutes les images du docker-compose.yml"
    silent: true
    preconditions:
    - sh: command -v docker
      msg: "Docker n'est pas installÃ© ou accessible"
    vars:
      COMPOSE_FILE: '{{.COMPOSE_FILE | default "docker-compose.yml"}}'
    summary: |
      Utilise docker-compose pour tÃ©lÃ©charger toutes les images dÃ©finies dans le fichier.

      Variables:
      - COMPOSE_FILE: Chemin vers le fichier docker-compose (dÃ©faut: docker-compose.yml)

      Exemples:
      task docker:images:pull
      task docker:images:pull COMPOSE_FILE=docker-compose.prod.yml
    cmds:
    - |
      if [ ! -f "{{.COMPOSE_FILE}}" ]; then
        echo "âŒ Le fichier '{{.COMPOSE_FILE}}' n'existe pas"
        exit 1
      fi

      echo "â¬‡ï¸  TÃ©lÃ©chargement des images depuis '{{.COMPOSE_FILE}}'..."


      # Extraction et tÃ©lÃ©chargement individuel des images pour Ã©viter les problÃ¨mes de dÃ©pendances
      echo "ğŸ” Images trouvÃ©es Ã  tÃ©lÃ©charger:"
      grep -E "^\s*image:" "{{.COMPOSE_FILE}}" | sed 's/.*image:\s*//' | sed 's/["'\'']*//g' | sort | uniq | while read -r image; do
        if [ -n "$image" ] && [ "$image" != "null" ]; then
          echo "  ğŸ³ $image"
        fi
      done
      echo ""

      # TÃ©lÃ©chargement individuel de chaque image
      grep -E "^\s*image:" "{{.COMPOSE_FILE}}" | sed 's/.*image:\s*//' | sed 's/["'\'']*//g' | sort | uniq | while read -r image; do
        if [ -n "$image" ] && [ "$image" != "null" ]; then
          image=$(echo "$image" | tr -d '\r\n' | xargs)
          if [[ "$image" =~ ^[a-zA-Z0-9._/-]+:[a-zA-Z0-9._-]+$ ]]; then
            echo "â¬‡ï¸  TÃ©lÃ©chargement de $image..."
            docker pull "$image" || echo "âš ï¸  Ã‰chec du tÃ©lÃ©chargement de $image"
          else
            echo "âš ï¸  Format d'image invalide: '$image'"
          fi
        fi
      done

  extract:
    desc: "Extrait les images vers un fichier texte"
    silent: true
    preconditions:
    - sh: command -v docker
      msg: "Docker n'est pas installÃ© ou accessible"
    vars:
      COMPOSE_FILE: '{{.COMPOSE_FILE | default "docker-compose.yml"}}'
      OUTPUT_FILE: '{{.OUTPUT_FILE | default "docker-images.txt"}}'
    summary: |
      Extrait la liste des images dans un fichier texte pour sauvegarde ou traitement.

      Variables:
      - COMPOSE_FILE: Fichier docker-compose source (dÃ©faut: docker-compose.yml)
      - OUTPUT_FILE: Fichier de sortie (dÃ©faut: docker-images.txt)

      Exemples:
      task docker:images:extract
      task docker:images:extract OUTPUT_FILE=images-prod.txt
    cmds:
    - |
      if [ ! -f "{{.COMPOSE_FILE}}" ]; then
        echo "âŒ Le fichier '{{.COMPOSE_FILE}}' n'existe pas"
        exit 1
      fi

      echo "ğŸ’¾ Extraction des images vers '{{.OUTPUT_FILE}}'..."

      if command -v yq >/dev/null 2>&1; then
        yq eval '.services.*.image' {{.COMPOSE_FILE}} 2>/dev/null | grep -v "null" | sort | uniq > {{.OUTPUT_FILE}}
      else
        grep -E "^\s*image:" {{.COMPOSE_FILE}} | sed 's/.*image:\s*//' | sed 's/["'\'']*//g' | sort | uniq > {{.OUTPUT_FILE}}
      fi

      echo "âœ… Images extraites dans '{{.OUTPUT_FILE}}'"
      echo "ğŸ“Š Nombre d'images trouvÃ©es: $(wc -l < {{.OUTPUT_FILE}})"

  check:
    desc: "VÃ©rifie la disponibilitÃ© des images localement"
    silent: true
    preconditions:
    - sh: command -v docker
      msg: "Docker n'est pas installÃ© ou accessible"
    vars:
      COMPOSE_FILE: '{{.COMPOSE_FILE | default "docker-compose.yml"}}'
    summary: |
      VÃ©rifie quelles images du docker-compose.yml sont prÃ©sentes localement.

      Variables:
      - COMPOSE_FILE: Chemin vers le fichier docker-compose (dÃ©faut: docker-compose.yml)
    cmds:
    - |
      if [ ! -f "{{.COMPOSE_FILE}}" ]; then
        echo "âŒ Le fichier '{{.COMPOSE_FILE}}' n'existe pas"
        exit 1
      fi

      echo "ğŸ” VÃ©rification de la disponibilitÃ© des images..."
      echo ""

      images=$(grep -E "^\s*image:" {{.COMPOSE_FILE}} | sed 's/.*image:\s*//' | sed 's/["'\'']*//g' | sort | uniq)

      while IFS= read -r image; do
        if [ -n "$image" ] && [ "$image" != "null" ]; then
          if docker image inspect "$image" >/dev/null 2>&1; then
            echo "  âœ… $image (disponible localement)"
          else
            echo "  âŒ $image (non disponible localement)"
          fi
        fi
      done <<< "$images"
